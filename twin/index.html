
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://andreavitaletti.github.io/IoT_short_course/twin/">
      
      
        <link rel="prev" href="../wireless/">
      
      
        <link rel="next" href="../os/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Digital Twin - A Short Course on IoT</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="lime" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#digital-twin" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="A Short Course on IoT" class="md-header__button md-logo" aria-label="A Short Course on IoT" data-md-component="logo">
      
  <img src="../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            A Short Course on IoT
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Digital Twin
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="A Short Course on IoT" class="md-nav__button md-logo" aria-label="A Short Course on IoT" data-md-component="logo">
      
  <img src="../assets/images/logo.png" alt="logo">

    </a>
    A Short Course on IoT
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../premise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Premise
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Intro
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../simulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simulate a node
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../real/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    A real node
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sample/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sampling the Environment
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../wireless/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wireless Connectivity
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Digital Twin
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Digital Twin
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estimating-clock-drift" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estimating clock drift
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Estimating clock drift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esp32-code-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        ESP32 Code (C++)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#digital-twin-python" class="md-nav__link">
    <span class="md-ellipsis">
      
        Digital Twin (Python)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maintenance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-difference-between-static-and-dynamic-unbalance" class="md-nav__link">
    <span class="md-ellipsis">
      
        The difference between Static and Dynamic Unbalance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-experiment" class="md-nav__link">
    <span class="md-ellipsis">
      
        A simple experiment
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        A simple model
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../os/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    An OS is better
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../energy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Energy matters
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../web3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IoT and Web3
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ml/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ML on node
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Backend
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../edge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Edge computing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filters
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../crowdsourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Crowdsourcing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../scale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    IoT-lab
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estimating-clock-drift" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estimating clock drift
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Estimating clock drift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Adjustment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#esp32-code-c" class="md-nav__link">
    <span class="md-ellipsis">
      
        ESP32 Code (C++)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#digital-twin-python" class="md-nav__link">
    <span class="md-ellipsis">
      
        Digital Twin (Python)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Maintenance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-difference-between-static-and-dynamic-unbalance" class="md-nav__link">
    <span class="md-ellipsis">
      
        The difference between Static and Dynamic Unbalance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-experiment" class="md-nav__link">
    <span class="md-ellipsis">
      
        A simple experiment
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        A simple model
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="digital-twin">Digital Twin</h1>
<h2 id="estimating-clock-drift">Estimating clock drift</h2>
<p>ESP32 internal oscillators are cost-effective but notoriously sensitive to temperature, leading to a drift that can be several seconds a day.</p>
<p>By building a <strong>Digital Twin</strong>, we aren't just syncing the time; we are creating a mathematical model that lives on your PC, predicts how "wrong" the ESP32 is at any given moment, and feeds back a correction.</p>
<h3 id="the-architecture">The Architecture</h3>
<p>To model the drift, the Twin needs to observe the relationship between the <strong>Physical Clock</strong> (ESP32) and the <strong>Reference Clock</strong> (PC).</p>
<p><img alt="image-2026231832291.png" src="../assets/images/image-2026231832291.png" /></p>
<p>We assume the clock drift is linear over short-to-medium durations. The relationship between the ESP32 time (<span class="arithmatex">\(t_{esp}\)</span>) and the PC time (<span class="arithmatex">\(t_{ref}\)</span>) can be modeled as:</p>
<div class="arithmatex">\[t_{esp} = (1 + R) \cdot t_{ref} + \phi\]</div>
<p><img alt="image-2026231539281.png" src="../assets/images/image-2026231539281.png" /></p>
<p>Where:</p>
<ul>
<li><strong><span class="arithmatex">\(R\)</span></strong>: The drift rate (the slope). If <span class="arithmatex">\(R &gt; 0\)</span>, the ESP32 is running fast.</li>
<li><strong><span class="arithmatex">\(\phi\)</span></strong>: The initial phase offset.</li>
</ul>
<p>The Digital Twin’s job is to continuously estimate <span class="arithmatex">\(R\)</span> and <span class="arithmatex">\(\phi\)</span> using <strong>Linear Regression</strong>.</p>
<h3 id="adjustment">Adjustment</h3>
<p>Once the Twin calculates the drift rate <span class="arithmatex">\(R\)</span>, it can send a <strong>Correction Factor</strong> back to the ESP32.</p>
<p>Instead of just resetting the time (which causes "time jumps"), the Digital Twin tells the ESP32 how much to "stretch" or "shrink" its perception of a second.</p>
<blockquote>
<p><strong>The Adjustment Logic:</strong></p>
<p>If the Twin calculates that the ESP32 is running <strong>1%</strong> fast, it sends a command: <code>drift_multiplier = 0.99</code>. The ESP32 then multiplies its internal delays or timestamps by this factor to stay in sync without jumping.</p>
</blockquote>
<p>If you simply did <code>micros() * multiplier</code>, the moment your Digital Twin sent a new multiplier (say, from <code>1.0001</code> to <code>0.9999</code>), your clock would instantly jump backwards by thousands of microseconds.</p>
<p>By using the <strong>Anchor Method</strong> (<span class="arithmatex">\(base + elapsed \times mult\)</span>), we ensure that:</p>
<ol>
<li><strong>Continuity:</strong> The time at the exact moment of the update remains the same.</li>
<li><strong>Smoothness:</strong> Only the <em>slope</em> of the time progression changes after the update.</li>
</ol>
<h3 id="esp32-code-c">ESP32 Code (C++)</h3>
<p>We add a <code>SET_PHASE</code> command to set the initial "Wall Clock" time.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Arduino.h&gt;</span>

<span class="kt">double</span><span class="w"> </span><span class="n">drift_multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="n">last_raw_micros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">base_wall_time_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// The Wall Clock time in seconds (Epoch)</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">get_wall_clock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">current_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">elapsed_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_raw</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_raw_micros</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Convert elapsed microseconds to adjusted seconds</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">elapsed_adjusted_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_raw</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">drift_multiplier</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">base_wall_time_s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">elapsed_adjusted_s</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Send heartbeat to Twin</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_report</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">last_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;RAW_MICROS:&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">micros</span><span class="p">());</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;,CUR_WALL:&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">get_wall_clock</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"> </span><span class="c1">// Tell the twin what we THINK the time is</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. Handle Commands</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Serial</span><span class="p">.</span><span class="n">readStringUntil</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// Set the &quot;Starting Line&quot; (Phase)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;SET_PHASE:&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">base_wall_time_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">toDouble</span><span class="p">();</span>
<span class="w">            </span><span class="n">last_raw_micros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;ACK: Phase (Wall Clock) Initialized.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Adjust the &quot;Speed&quot; (Frequency)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s">&quot;SET_MULT:&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Anchor the time before changing the rate</span>
<span class="w">            </span><span class="n">base_wall_time_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_wall_clock</span><span class="p">();</span>
<span class="w">            </span><span class="n">last_raw_micros</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micros</span><span class="p">();</span>
<span class="w">            </span><span class="n">drift_multiplier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="mi">9</span><span class="p">).</span><span class="n">toDouble</span><span class="p">();</span>
<span class="w">            </span><span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;ACK: Rate Adjusted.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h3 id="digital-twin-python">Digital Twin (Python)</h3>
<p>The Python script now performs two steps:</p>
<ol>
<li><strong>Sync Phase:</strong> Sends the current PC time immediately upon connection.</li>
<li><strong>Sync Frequency:</strong> Continues to calculate and send the drift multiplier.</li>
</ol>
<p>Python</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># ... (Previous Class Setup) ...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">twin</span> <span class="o">=</span> <span class="n">ClockDigitalTwin</span><span class="p">()</span>
    <span class="n">phase_synced</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s1">&#39;COM3&#39;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">ser</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Wait for ESP32 reboot</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># 1. INITIAL PHASE SYNC</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_synced</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SET_PHASE:</span><span class="si">{</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">phase_synced</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent initial Phase: </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;RAW_MICROS&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># Parse: RAW_MICROS:12345,CUR_WALL:17000.123</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">raw_micros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">esp_thinks_wall</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">twin</span><span class="o">.</span><span class="n">add_sample</span><span class="p">(</span><span class="n">raw_micros</span><span class="p">)</span>

                <span class="c1"># 2. FREQUENCY ADJUSTMENT</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="n">twin</span><span class="o">.</span><span class="n">calculate_multiplier</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mult</span><span class="p">:</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SET_MULT:</span><span class="si">{</span><span class="n">mult</span><span class="si">:</span><span class="s2">.8f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">esp_thinks_wall</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correction sent. Current Error: </span><span class="si">{</span><span class="n">error</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>The Phase Correction (<code>SET_PHASE</code>)</strong>: This is like setting a watch. It happens once (or rarely) to align the two clocks to the same "zero" point.</li>
<li><strong>The Frequency Correction (<code>SET_MULT</code>)</strong>: This is like adjusting the watch's internal gears. It happens continuously to ensure that as the ESP32 gets hot or cold, the Digital Twin keeps the "Virtual Clock" perfectly aligned with the PC.</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Clock drift depends on the temperature </p>
</div>
<h2 id="maintenance">Maintenance</h2>
<ul>
<li>Periodic</li>
<li>Preventive</li>
<li>Predictive</li>
<li>Reactive</li>
</ul>
<p><img alt="" src="../assets/images/2025-02-22-08-39-20.png" title="https://www.sim-tek.com.tr/predictive-maintenance/" /></p>
<h2 id="the-difference-between-static-and-dynamic-unbalance"><a href="https://www.youtube.com/watch?v=JB8i7LtY3mU">The difference between Static and Dynamic Unbalance</a></h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/JB8i7LtY3mU?si=5j4mh8RmYGS-83ng" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

<h2 id="a-simple-experiment">A simple experiment</h2>
<p><img alt="" src="../assets/images/schematics.png" />
<img alt="" src="../assets/images/device.png" />
<img alt="" src="../assets/images/rest.png" />
<img alt="" src="../assets/images/balanced.png" />
<img alt="" src="../assets/images/unbalanced.png" /></p>
<p><a href="https://github.com/andreavitaletti/PlatformIO/tree/main/Projects/Digital_twin">code</a></p>
<h2 id="a-simple-model">A simple model</h2>
<p>Centrifugal force of a mass <span class="arithmatex">\(m_e\)</span> at distance <span class="arithmatex">\(r\)</span> from the center of rotation, with angular velocity <span class="arithmatex">\(\omega\)</span>: <span class="arithmatex">\(F​=m_e ​r \omega\)</span></p>
<p>Using a lumped mass model, and assuming the damping coefficient and the stiffness of the support are negligible, if the mass or the rotor is <span class="arithmatex">\(m\)</span>, we can write :</p>
<p><span class="arithmatex">\(m \ddot{x} = m_e ​r \omega^2 cos(\omega t)\)</span></p>
<p><span class="arithmatex">\(m \ddot{y} = m_e ​r \omega^2 sin(\omega t)\)</span></p>
<p>This allows us to estimate the accelerations under the simplistic assumptions we made. </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Created by Andrea Vitaletti.<br/><img alt="" style="border-width:0" src="https://andreavitaletti.github.io/IoT_short_course/assets/images/mail.png" /></br><a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/TZhMmbgq" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/andrea-vitaletti-3651442/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>